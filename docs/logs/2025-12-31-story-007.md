# Session: Story 007 - Environment Variable Runtime Support
**Date:** 2025-12-31

## Overview
Enabled `CONTEXT7_API_KEY` environment variable to be used for ALL commands (not just init), eliminating need to run init when env var is already set. This addresses user's issue where env var in `.zshrc` wasn't working for queries.

## Root Cause
Users set `CONTEXT7_API_KEY` in their shell profile but:
1. Env var was only checked during `coderef --init`
2. All subsequent queries only read from `~/.coderef/config.toml`
3. Users had to run init even with env var set

## Key Decisions

1. **Runtime Env Var**: Check `CONTEXT7_API_KEY` for every command (init, queries, etc.)
2. **Clear Precedence**: Env var > config file (env var wins always)
3. **Debug Mode Support**: Show which source is being used (env var or config)
4. **Industry Standard**: Matches AWS CLI, Docker, and other tools

## Artifacts Modified

**Created:**
- `docs/stories/007-env-var-runtime.md` (story document, moved to completed)

**Modified:**
- `src/coderef/main.py` - Check env var at runtime (~20 lines)
  - Added env var check before config file in main() function
  - Added DEBUG environment variable support
  - Added debug logging for both env var and config sources
  - Added debug logging in _run_init_flow() to show source
- `README.md` - Updated documentation (~20 lines)
  - Modified "Option 1" to explain runtime behavior
  - Added note about working immediately without init
  - Updated "Configuration not found" section with note
- `docs/core/ARCHITECTURE.md` - Added precedence rules (~15 lines)
  - Added "Configuration Precedence" section
  - Updated "Environment Variable" section to clarify runtime behavior

## Open Items

None - story complete. All acceptance criteria met.

## Testing

**All 45 tests pass** - No regressions introduced

**Manual Testing:**
- ✅ Env var set, no config: Uses env var, shows debug message
- ✅ Config file, no env var: Uses config, shows debug fallback message
- ✅ Both set (env var wins): Uses env var, shows debug message
- ✅ Neither set: Shows "Configuration not found" error
- ✅ Init with env var: Shows which source key came from

## Configuration Precedence

```
1. Environment variable: CONTEXT7_API_KEY (highest priority)
2. Config file: ~/.coderef/config.toml (fallback)
```

## User's Use Case

**Before:**
```bash
# In .zshrc:
export CONTEXT7_API_KEY=ctx7sk-...

# Had to run init first:
coderef --init

# Then could query:
coderef "C++ lambda functions" --library C++
```

**After:**
```bash
# In .zshrc:
export CONTEXT7_API_KEY=ctx7sk-...

# Works immediately, no init needed:
coderef "C++ lambda functions" --library C++
```

## Next Steps

User can now use coderef immediately after setting `CONTEXT7_API_KEY` in their shell profile:

```bash
# Set in .zshrc
export CONTEXT7_API_KEY=ctx7sk-...

# Reload shell
source ~/.zshrc

# Works immediately
coderef "How do I use React hooks?"

# Or with debug output to see which source is being used:
DEBUG=true coderef "How do I use React hooks?"
```

This matches user expectations and industry standards.
