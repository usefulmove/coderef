# Session: Story 006 - Improve Environment Variable Detection and Error Messaging
**Date:** 2025-12-31

## Overview
Added debug mode support and improved error messaging to help users diagnose environment variable configuration issues. This addresses user's problem where `CONTEXT7_API_KEY` set in `.zshrc` wasn't being detected.

## Root Cause
Users set `CONTEXT7_API_KEY` in their shell profile but:
1. No visibility into whether env var is being detected
2. Error messages don't help distinguish between "not set" vs. "invalid format"
3. No guidance on how to verify env var is loaded in current shell

## Key Decisions

1. **Add Debug Mode**: Support `--debug` flag or `DEBUG=true` env var for detailed logging
2. **Improve Error Messages**: Add specific guidance (verify with `echo $CONTEXT7_API_KEY`)
3. **Document Troubleshooting**: Add 5-step guide for common shell configuration issues

## Artifacts Modified

**Created:**
- `docs/stories/006-env-var-diagnostics.md` (story document, moved to completed)

**Modified:**
- `src/coderef/main.py` - Added `--debug` flag, updated `_run_init_flow()` with debug logging and improved error messages (~25 lines)
- `README.md` - Added "Environment variable not detected" subsection with 5 troubleshooting steps, updated flags table and command reference

## Open Items

None - story complete. All acceptance criteria met.

## Testing

**Manual Testing:**
- ✅ Env var not set, DEBUG=true: Shows debug logs and helpful message
- ✅ Env var not set, --debug flag: Works the same as DEBUG=true
- ✅ Env var set and valid, DEBUG=true: Shows env var value (masked) and uses it
- ✅ Env var set and invalid, DEBUG=true: Shows improved error message with verification steps

**All 45 tests pass** - No regressions introduced

## User Guidance for Their Issue

For user's specific issue (env var set in `.zshrc` but not detected):

1. Reload shell profile: `source ~/.zshrc`
2. Or restart terminal
3. Verify env var is loaded: `echo $CONTEXT7_API_KEY`
4. Test with debug mode: `DEBUG=true coderef --init`

The --debug flag will now show detailed information to help diagnose if env var is being read correctly.

## Next Steps

User can now debug their environment variable configuration:
```bash
# Check if env var is loaded
echo $CONTEXT7_API_KEY

# Reload shell profile
source ~/.zshrc

# Run init with debug output
DEBUG=true coderef --init
```

Debug output will show exactly what coderef sees when checking for the environment variable.
